<div class="comparador-layout">

    <main class="main-content" id="mainContent">

      <!-- Navigation Tabs -->
      <div class="comparador-nav-tabs">
        <button class="nav-tab active" id="nuevaTab" onclick="switchTab('nueva')">Nueva Comparativa</button>
        <button class="nav-tab" id="historicoTab" onclick="switchTab('historico')">Historico</button>
      </div>

      <div class="page-header">
        <h1 class="page-title">‚ö° Comparador de Facturas El√©ctricas</h1>
        <p class="page-subtitle">Analiza facturas de clientes y encuentra oportunidades de ahorro</p>
      </div>

      <div class="user-info-bar" id="userInfo">
        <span>üë§</span>
        <span id="userInfoText">Cargando usuario...</span>
      </div>

      <!-- History Section (for Historico tab) -->
      <div id="history-section" style="display: none;">
        <!-- History List View -->
        <div id="history-list-view">
          <div class="history-container">
            <div class="history-filters">
              <div class="filter-group">
                <label class="filter-label">üîç Buscar CUPS</label>
                <input type="text" class="filter-input" id="filterCups" placeholder="Ej: ES0021000...">
              </div>

              <div class="filter-group">
                <label class="filter-label">‚ö° Tipo Suministro</label>
                <select class="filter-select" id="filterTipo">
                  <option value="">Todos</option>
                  <option value="luz">‚ö° Luz</option>
                  <option value="gas">üî• Gas</option>
                </select>
              </div>

              <div class="filter-group">
                <label class="filter-label">üìã Tarifa</label>
                <select class="filter-select" id="filterTarifa">
                  <option value="">Todas</option>
                  <option value="2.0TD">2.0TD</option>
                  <option value="3.0TD">3.0TD</option>
                  <option value="6.1TD">6.1TD</option>
                </select>
              </div>
            </div>

            <div class="history-list" id="historyList">
              <div class="history-loading">
                <div class="history-spinner"></div>
                <div>Cargando historial...</div>
              </div>
            </div>
          </div>
        </div>

        <!-- History Results View (shown when viewing a history item) -->
        <div id="history-results-view" style="display: none;">
          <button class="back-to-history-btn" id="backToHistoryBtn" onclick="backToHistoryList()">
            ‚Üê Volver al Historial
          </button>
          <div id="history-results-container"></div>
        </div>
      </div>

      <div id="upload-section">

        <!-- Main Action Grid: Upload + Action Buttons -->
        <div class="main-action-grid">

          <!-- Left Column: Upload Section -->
          <div class="upload-column">
            <div class="config-section">
              <div class="section-title">
                <span class="step-number">1</span>
                üìÑ Subir Factura
              </div>

              <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üìÑ</div>
                <div class="upload-text">Arrastra la factura aqu√≠</div>
                <div class="upload-subtext">PDF o imagen (m√°x. 5 MB)</div>
              </div>

              <input type="file" id="fileInput" class="file-input" accept=".pdf,image/*">

              <div class="selected-file" id="selectedFile">
                <div class="file-icon">üìÑ</div>
                <div class="file-info">
                  <div class="file-name" id="fileName"></div>
                  <div class="file-size" id="fileSize"></div>
                </div>
                <button class="remove-file" id="removeFile">‚úï</button>
              </div>

              <!-- Bill Data Summary (shown when file is uploaded and analyzed) -->
              <div class="bill-data-summary" id="billDataSummary" style="display: none;">
                <div class="bill-data-grid">
                  <div class="bill-data-item">
                    <span class="bill-data-label">CUPS</span>
                    <span class="bill-data-value" id="billCups">‚Äî</span>
                  </div>
                  <div class="bill-data-item">
                    <span class="bill-data-label">Tarifa</span>
                    <span class="bill-data-value bill-data-highlight" id="billTarifa">‚Äî</span>
                  </div>
                  <div class="bill-data-item">
                    <span class="bill-data-label">Titular</span>
                    <span class="bill-data-value" id="billTitular">‚Äî</span>
                  </div>
                  <div class="bill-data-item">
                    <span class="bill-data-label">NIF</span>
                    <span class="bill-data-value" id="billNif">‚Äî</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Right Column: Action Buttons -->
          <div class="actions-column">
            <div class="section-title">
              <span class="step-number">2</span>
              Selecciona una Acci√≥n
            </div>

            <div class="action-buttons-grid">
              <!-- Comparar Tarifa Button -->
              <button class="big-action-button tarifa-button" id="compararTarifaBtn" disabled>
                <div class="action-button-icon">
                  <span>üìä</span>
                </div>
                <div class="action-button-content">
                  <h3 class="action-button-title">üìä Comparar Tarifa</h3>
                  <p class="action-button-desc">Encuentra el mejor producto para este cliente</p>
                </div>
                <div class="action-button-footer">
                  <span class="action-button-hint" id="tarifaHint">Sube una factura primero</span>
                  <span class="action-button-arrow">‚Üí</span>
                </div>
              </button>

              <!-- Analizar Potencia Button -->
              <button class="big-action-button potencia-button" id="analizarPotenciaBtn" disabled>
                <div class="action-button-icon">
                  <span>‚ö°</span>
                </div>
                <div class="action-button-content">
                  <h3 class="action-button-title">‚ö° Analizar Potencia</h3>
                  <p class="action-button-desc">Optimiza la potencia contratada y reduce costes fijos</p>
                </div>
                <div class="action-button-footer">
                  <span class="action-button-hint" id="potenciaHint">Sube una factura primero</span>
                  <span class="action-button-arrow">‚Üí</span>
                </div>
              </button>
            </div>
          </div>
        </div>

        <!-- Info Cards Row -->
        <div class="info-cards-row">
          <div class="info-card-small">
            <h3 class="info-card-title-small">üìä Sobre Comparar Tarifa</h3>
            <p class="info-card-desc">Compara autom√°ticamente con los productos disponibles.</p>
            <ul class="info-card-list">
              <li><span class="check-icon">‚úì</span> Extrae datos autom√°ticamente con IA</li>
              <li><span class="check-icon">‚úì</span> Calcula ahorro mensual y anual</li>
              <li><span class="check-icon">‚úì</span> Genera PDF de comparativa</li>
            </ul>
          </div>

          <div class="info-card-small">
            <h3 class="info-card-title-small">‚ö° Sobre Analizar Potencia</h3>
            <p class="info-card-desc">Analiza si el cliente tiene la potencia √≥ptima contratada.</p>
            <ul class="info-card-list">
              <li><span class="check-icon">‚úì</span> Detecta sobredimensionamiento</li>
              <li><span class="check-icon">‚úì</span> Recomienda potencia √≥ptima</li>
              <li><span class="check-icon">‚úì</span> Estima ahorro en t√©rmino fijo</li>
            </ul>
          </div>
        </div>

        <!-- Hidden Configuration Options (for advanced settings - collapsible) -->
        <details class="advanced-options" id="advancedOptions">
          <summary class="advanced-options-toggle">
            <span>‚öôÔ∏è Opciones avanzadas</span>
            <span class="toggle-arrow">‚ñº</span>
          </summary>

          <div class="advanced-options-content">
            <div class="horizontal-sections">
              <div class="config-section">
                <div class="section-title">Tipo de comparaci√≥n:</div>
                <div class="radio-group">
                  <div class="radio-option">
                    <input type="radio" id="product-all" name="product-type" value="all" checked="">
                    <label for="product-all" class="radio-label">
                      <div class="radio-label-title">Todos los productos</div>
                      <div class="radio-label-desc">Compara con todas las ofertas</div>
                    </label>
                  </div>
                  <div class="radio-option">
                    <input type="radio" id="product-24h" name="product-type" value="24h">
                    <label for="product-24h" class="radio-label">
                      <div class="radio-label-title">Productos 24h</div>
                      <div class="radio-label-desc">Precio √∫nico todo el d√≠a</div>
                    </label>
                  </div>
                </div>
              </div>

              <div class="config-section">
                <div class="section-title">üìà M√©todo de Comparaci√≥n:</div>
                <div class="radio-group">
                  <div class="radio-option">
                    <input type="radio" id="method-factura" name="comparison-method" value="factura" checked="">
                    <label for="method-factura" class="radio-label">
                      <div class="radio-label-title">üìÑ Consumo en Factura</div>
                      <div class="radio-label-desc">Usa el consumo de la factura</div>
                    </label>
                  </div>
                  <div class="radio-option">
                    <input type="radio" id="method-anual" name="comparison-method" value="anual">
                    <label for="method-anual" class="radio-label">
                      <div class="radio-label-title">üìÖ Consumo Anual</div>
                      <div class="radio-label-desc">Usa datos anuales de SIPS</div>
                    </label>
                  </div>
                </div>
              </div>
            </div>

            <div class="company-selector" id="companySelector">
              <div class="section-title">Comercializadoras Disponibles:</div>
              <div class="company-dropdown">
                <button class="company-dropdown-button" id="companyDropdownButton" type="button">
                  <span id="companySelectionText">Seleccionar comercializadoras...</span>
                  <span class="dropdown-arrow">‚ñº</span>
                </button>
                <div class="company-dropdown-menu" id="companyDropdownMenu">
                  <div class="company-loading">Cargando comercializadoras...</div>
                </div>
              </div>
              <div class="company-error" id="companyError">
                Debes seleccionar al menos 3 comercializadoras
              </div>
            </div>
          </div>
        </details>

      </div>

      <!-- Power Analysis Only Section -->
      <div id="power-analysis-only-section" style="display: none;">
        <div class="page-header">
          <h1 class="page-title">‚ö° An√°lisis de Potencia</h1>
          <p class="page-subtitle">Optimiza la potencia contratada del cliente</p>
        </div>

        <!-- Input Method Selector -->
        <div class="power-input-method-selector">
          <div class="section-title">üìã M√©todo de Entrada:</div>
          <div class="radio-group">
            <div class="radio-option">
              <input type="radio" id="power-method-bill" name="power-input-method" value="bill" checked>
              <label for="power-method-bill" class="radio-label">
                <div class="radio-label-title">üìÑ Subir Factura</div>
                <div class="radio-label-desc">Extrae CUPS y precios autom√°ticamente</div>
              </label>
            </div>
            <div class="radio-option">
              <input type="radio" id="power-method-manual" name="power-input-method" value="manual">
              <label for="power-method-manual" class="radio-label">
                <div class="radio-label-title">‚å®Ô∏è Entrada Manual</div>
                <div class="radio-label-desc">Introduce CUPS y precios manualmente</div>
              </label>
            </div>
          </div>
        </div>

        <!-- Bill Upload Form -->
        <div id="power-bill-form" class="power-input-form">
          <div class="section-title">üìÑ Subir Factura:</div>

          <div class="upload-area" id="powerUploadArea">
            <div class="upload-icon">üìÑ</div>
            <div class="upload-text">Arrastra la factura del cliente aqu√≠ o haz clic para seleccionar</div>
            <div class="upload-subtext">Solo archivos PDF (m√°x. 5 MB)</div>
          </div>

          <input type="file" id="powerFileInput" class="file-input" accept=".pdf">

          <div class="selected-file" id="powerSelectedFile" style="display: none;">
            <div class="file-icon">üìÑ</div>
            <div class="file-info">
              <div class="file-name" id="powerFileName"></div>
              <div class="file-size" id="powerFileSize"></div>
            </div>
            <button class="remove-file" id="powerRemoveFile">‚úï</button>
          </div>

          <!-- User Info for Bill -->
          <div class="power-user-info">
            <div class="section-title">üë§ Informaci√≥n del Cliente:</div>
            <div class="form-grid">
              <div class="form-group">
                <label for="powerBillUserName">Nombre:</label>
                <input type="text" id="powerBillUserName" placeholder="Nombre del cliente" value="Tunet">
              </div>
              <div class="form-group">
                <label for="powerBillUserEmail">Email:</label>
                <input type="email" id="powerBillUserEmail" placeholder="email@ejemplo.com" value="info@tunergia.es">
              </div>
              <div class="form-group">
                <label for="powerBillUserPhone">Tel√©fono (opcional):</label>
                <input type="tel" id="powerBillUserPhone" placeholder="+34 600 000 000">
              </div>
            </div>
          </div>
        </div>

        <!-- Manual Input Form -->
        <div id="power-manual-form" class="power-input-form" style="display: none;">
          <div class="section-title">‚å®Ô∏è Datos Manuales:</div>

          <!-- CUPS and Tariff -->
          <div class="form-grid">
            <div class="form-group">
              <label for="powerManualCups">CUPS: *</label>
              <input type="text" id="powerManualCups" placeholder="ES0021000..." required>
            </div>
            <div class="form-group">
              <label for="powerManualTariff">Tarifa: *</label>
              <select id="powerManualTariff" required>
                <option value="3.0TD" selected>3.0TD</option>
                <option value="2.0TD">2.0TD</option>
                <option value="6.1TD">6.1TD</option>
              </select>
            </div>
          </div>

          <!-- User Info for Manual -->
          <div class="power-user-info">
            <div class="section-title">üë§ Informaci√≥n del Cliente:</div>
            <div class="form-grid">
              <div class="form-group">
                <label for="powerManualUserName">Nombre:</label>
                <input type="text" id="powerManualUserName" placeholder="Nombre del cliente" value="Tunet">
              </div>
              <div class="form-group">
                <label for="powerManualUserEmail">Email:</label>
                <input type="email" id="powerManualUserEmail" placeholder="email@ejemplo.com" value="info@tunergia.es">
              </div>
              <div class="form-group">
                <label for="powerManualUserPhone">Tel√©fono (opcional):</label>
                <input type="tel" id="powerManualUserPhone" placeholder="+34 600 000 000">
              </div>
            </div>
          </div>

          <!-- Optional Price Inputs -->
          <div class="power-prices-section">
            <div class="power-prices-header">
              <div class="section-title">üí∞ Precios de Potencia (Opcional):</div>
              <div class="power-prices-note">
                Si no se especifican, se usar√°n los precios BOE por defecto
              </div>
            </div>

            <div class="power-prices-toggle">
              <input type="checkbox" id="powerCustomPricesToggle">
              <label for="powerCustomPricesToggle">Especificar precios personalizados</label>
            </div>

            <div id="powerCustomPricesFields" class="power-prices-grid" style="display: none;">
              <div class="form-group">
                <label for="powerPriceP1">P1 (‚Ç¨/kW¬∑d√≠a):</label>
                <input type="number" id="powerPriceP1" step="0.000001" placeholder="0.053858904">
              </div>
              <div class="form-group">
                <label for="powerPriceP2">P2 (‚Ç¨/kW¬∑d√≠a):</label>
                <input type="number" id="powerPriceP2" step="0.000001" placeholder="0.028086712">
              </div>
              <div class="form-group">
                <label for="powerPriceP3">P3 (‚Ç¨/kW¬∑d√≠a):</label>
                <input type="number" id="powerPriceP3" step="0.000001" placeholder="0.011678192">
              </div>
              <div class="form-group">
                <label for="powerPriceP4">P4 (‚Ç¨/kW¬∑d√≠a):</label>
                <input type="number" id="powerPriceP4" step="0.000001" placeholder="0.010086438">
              </div>
              <div class="form-group">
                <label for="powerPriceP5">P5 (‚Ç¨/kW¬∑d√≠a):</label>
                <input type="number" id="powerPriceP5" step="0.000001" placeholder="0.006378548">
              </div>
              <div class="form-group">
                <label for="powerPriceP6">P6 (‚Ç¨/kW¬∑d√≠a):</label>
                <input type="number" id="powerPriceP6" step="0.000001" placeholder="0.003716137">
              </div>
            </div>
          </div>
        </div>

        <!-- Submit Button -->
        <button class="analyze-button" id="analyzePowerButton" disabled>
          ‚ö° Analizar Potencia
        </button>
      </div>

      <div class="loading" id="loading">
        <div class="spinner"></div>
        <div class="loading-text">Analizando factura del cliente...</div>
        <div class="loading-progress" id="loadingProgress"></div>
      </div>

      <div class="error-message" id="errorMessage"></div>

      <div class="results" id="results"></div>
    </main>

  </div>

  
  
  
  <div class="turbo-tun-overlay" id="turboTunOverlay">
    <div class="turbo-tun-container">
      <div class="turbo-tun-header">
        <div class="turbo-tun-title">
          <span>üöÄ</span>
          <span>Turbo Tun Mode - C√°lculo Personalizado</span>
        </div>
        <button class="turbo-tun-close" onclick="closeTurboTun()">‚úï</button>
      </div>
      
      <div class="turbo-tun-body">
        
        <div class="turbo-tun-section">
          <div class="turbo-tun-section-title">
            <span>üîå</span>
            <span>CUPS: <span id="turboTunCups">N/A</span></span>
            <span style="margin-left: auto; font-size: 14px; font-weight: 600; color: #667eea;">Tarifa: <span id="turboTunTarifa">N/A</span></span>
          </div>
        </div>
        
        
        <div class="turbo-tun-section">
          <div class="turbo-tun-section-title">
            <span>üìä</span>
            <span>Consumos (kWh)</span>
          </div>
          <div class="turbo-tun-grid" id="consumptionFields"></div>
        </div>
        
        
        <div class="turbo-tun-section">
          <div class="turbo-tun-section-title">
            <span>‚ö°</span>
            <span>Potencias Contratadas (kW)</span>
          </div>
          <div class="turbo-tun-grid" id="powerFields"></div>
        </div>
        
        
        <div class="turbo-tun-section">
          <div class="turbo-tun-section-title">
            <span>üí∞</span>
            <span>Precios Energ√≠a (‚Ç¨/kWh)</span>
          </div>
          <div class="turbo-tun-grid" id="energyPriceFields"></div>
        </div>
        
        
        <div class="turbo-tun-section">
          <div class="turbo-tun-section-title">
            <span>üíµ</span>
            <span>Precios Potencia (‚Ç¨/kW/d√≠a)</span>
          </div>
          <div class="turbo-tun-grid" id="powerPriceFields"></div>
        </div>
        
        
        <div class="turbo-tun-section">
          <div class="turbo-tun-section-title">
            <span>üè¢</span>
            <span>Producto para C√°lculo</span>
          </div>
          <select class="turbo-tun-product-selector" id="turboTunProductSelect">
            <option value="">Selecciona un producto...</option>
          </select>
        </div>
        
        
        <div class="turbo-tun-result" id="turboTunResult">
          <h4 style="font-size: 16px; font-weight: 700; color: #2d3748; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
            <span>üìä</span>
            <span>Resultado de la Comparaci√≥n</span>
          </h4>
          <div class="turbo-tun-result-grid">
            
            <div class="turbo-tun-result-card current">
              <div class="turbo-tun-result-card-header">
                <span>üìä</span>
                <span>Factura Actual</span>
              </div>
              <div class="turbo-tun-result-card-value" id="turboTunCurrentTotal">0.00 ‚Ç¨</div>
            </div>
            
            
            <div class="turbo-tun-result-card scenario">
              <div class="turbo-tun-result-card-header">
                <span>üßÆ</span>
                <span>Escenario Personalizado</span>
              </div>
              <div class="turbo-tun-result-card-value" id="turboTunScenarioTotal">0.00 ‚Ç¨</div>
              <div class="turbo-tun-result-breakdown">
                <div class="turbo-tun-result-breakdown-row">
                  <span>üí° Energ√≠a:</span>
                  <span id="turboTunEnergyCost">0.00 ‚Ç¨</span>
                </div>
                <div class="turbo-tun-result-breakdown-row">
                  <span>‚ö° Potencia:</span>
                  <span id="turboTunPowerCost">0.00 ‚Ç¨</span>
                </div>
                <div class="turbo-tun-result-breakdown-row">
                  <span>üìã Otros:</span>
                  <span id="turboTunOtherCosts">0.00 ‚Ç¨</span>
                </div>
              </div>
            </div>
            
            
            <div class="turbo-tun-result-card savings" id="turboTunSavingsCard">
              <div class="turbo-tun-result-card-header">
                <span>üí∞</span>
                <span>Ahorro</span>
              </div>
              <div class="turbo-tun-result-card-value" id="turboTunSavingsValue">+0.00 ‚Ç¨</div>
              <div class="turbo-tun-result-annual" id="turboTunSavingsAnnual">0.00 ‚Ç¨/a√±o (0.0%)</div>
            </div>
          </div>
        </div>
        
        
        <div class="turbo-tun-actions">
          <button class="turbo-tun-button turbo-tun-button-reset" onclick="resetTurboTunFields()">
            üîÑ Restablecer Valores
          </button>
          <button class="turbo-tun-button turbo-tun-button-calculate" id="turboTunCalculateBtn" onclick="calculateCustomScenario()">
            üßÆ Calcular Escenario
          </button>
        </div>
      </div>
    </div>
  </div>
