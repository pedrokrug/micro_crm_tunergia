<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>An√°lisis de Potencia - Tunergia</title>

  <!-- Google Fonts - Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    /* ============================================
       POWER ANALYSIS TOOL - CSS Styles
       ============================================ */

    /* Base styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Layout */
    .power-analysis-layout {
      display: flex;
      min-height: 100vh;
      background: #f5f7fa;
    }

    .power-analysis-main {
      flex: 1;
      padding: 30px;
      max-width: 1200px;
      margin: 0 auto;
    }

    /* Page Header */
    .page-header {
      margin-bottom: 24px;
    }

    .page-title {
      font-size: 28px;
      font-weight: 700;
      color: #2d3748;
      margin: 0 0 8px 0;
    }

    .page-subtitle {
      font-size: 16px;
      color: #718096;
      margin: 0;
    }

    /* User Info Bar */
    .user-info-bar {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      margin-bottom: 24px;
      font-size: 14px;
      color: #4a5568;
    }

    /* Config Sections */
    .config-section {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
    }

    .section-title {
      font-size: 16px;
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-subtitle {
      font-size: 14px;
      color: #718096;
      margin-top: -8px;
      margin-bottom: 16px;
    }

    .section-title-with-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .section-title-with-info .section-title {
      margin-bottom: 0;
    }

    .info-badge {
      background: #e6f3ff;
      color: #4393CE;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      cursor: help;
    }

    /* Bill Question Section */
    .bill-question-section {
      background: linear-gradient(135deg, #f8fbff 0%, #fff 100%);
      border: 2px solid #4393CE;
    }

    /* Radio Groups */
    .radio-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .radio-group.horizontal {
      flex-direction: row;
      gap: 16px;
    }

    .radio-option {
      flex: 1;
    }

    .radio-option input[type="radio"] {
      display: none;
    }

    .radio-label {
      display: block;
      padding: 16px 20px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
      background: white;
    }

    .radio-label:hover {
      border-color: #4393CE;
      background: #f8fbff;
    }

    .radio-option input[type="radio"]:checked + .radio-label {
      border-color: #4393CE;
      background: #e6f3ff;
    }

    .radio-label-title {
      font-size: 15px;
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 4px;
    }

    .radio-label-desc {
      font-size: 13px;
      color: #718096;
    }

    /* CUPS Input */
    .cups-input-section {
      margin-top: 20px;
    }

    .cups-input-wrapper {
      position: relative;
    }

    .cups-input {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 16px;
      font-family: 'Courier New', monospace;
      letter-spacing: 1px;
      transition: all 0.2s ease;
      box-sizing: border-box;
    }

    .cups-input:focus {
      outline: none;
      border-color: #4393CE;
      box-shadow: 0 0 0 3px rgba(67, 147, 206, 0.1);
    }

    .cups-input.valid {
      border-color: #48bb78;
      background: #f0fff4;
    }

    .cups-input.invalid {
      border-color: #fc8181;
      background: #fff5f5;
    }

    .cups-input-hint {
      font-size: 12px;
      color: #718096;
      margin-top: 8px;
    }

    /* Power Prices Section */
    .power-prices-section {
      margin-top: 20px;
    }

    .power-prices-note {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      background: #fffbeb;
      border: 1px solid #fbd38d;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 13px;
      color: #744210;
    }

    .note-icon {
      font-size: 16px;
    }

    .power-prices-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }

    @media (max-width: 768px) {
      .power-prices-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (max-width: 480px) {
      .power-prices-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .power-price-field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .power-price-field label {
      font-size: 13px;
      font-weight: 700;
      color: #4393CE;
      text-align: center;
    }

    .price-input {
      padding: 10px 8px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 12px;
      text-align: center;
      transition: all 0.2s ease;
    }

    .price-input:focus {
      outline: none;
      border-color: #4393CE;
      box-shadow: 0 0 0 3px rgba(67, 147, 206, 0.1);
    }

    .reset-prices-button {
      background: #f7fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 10px 16px;
      font-size: 13px;
      color: #718096;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .reset-prices-button:hover {
      background: #edf2f7;
      color: #4a5568;
    }

    /* File Upload Section */
    .file-upload-section {
      margin-top: 20px;
    }

    .upload-area {
      background: white;
      border: 3px dashed #cbd5e0;
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      transition: all 0.3s ease;
      cursor: pointer;
      margin-bottom: 20px;
    }

    .upload-area:hover {
      border-color: #4393CE;
      background: #f8fbff;
    }

    .upload-area.dragover {
      background: #e6f3ff;
      border-color: #4393CE;
      border-style: solid;
    }

    .upload-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .upload-text {
      font-size: 16px;
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 8px;
    }

    .upload-subtext {
      font-size: 13px;
      color: #718096;
    }

    .file-input {
      display: none;
    }

    .selected-file {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 16px;
      display: none;
      align-items: center;
      gap: 12px;
    }

    .selected-file.active {
      display: flex;
    }

    .file-icon {
      font-size: 24px;
    }

    .file-info {
      flex: 1;
    }

    .file-name {
      font-size: 14px;
      font-weight: 600;
      color: #2d3748;
    }

    .file-size {
      font-size: 12px;
      color: #718096;
    }

    .remove-file {
      background: #fed7d7;
      border: none;
      border-radius: 6px;
      width: 28px;
      height: 28px;
      font-size: 14px;
      color: #c53030;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .remove-file:hover {
      background: #fc8181;
      color: white;
    }

    /* Analyze Button */
    .analyze-button {
      background: linear-gradient(135deg, #4393CE 0%, #357AB8 100%);
      color: white;
      border: none;
      border-radius: 10px;
      padding: 16px 32px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      width: 100%;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(67, 147, 206, 0.3);
    }

    .analyze-button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(67, 147, 206, 0.4);
    }

    .analyze-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    /* Loading State */
    .loading {
      display: none;
      text-align: center;
      margin-top: 30px;
      padding: 40px;
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
    }

    .loading.active {
      display: block;
    }

    .spinner {
      border: 4px solid #e2e8f0;
      border-radius: 50%;
      border-top: 4px solid #4393CE;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 16px;
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 8px;
    }

    .loading-progress {
      font-size: 14px;
      color: #718096;
    }

    /* Error Message */
    .error-message {
      display: none;
      background: #fff5f5;
      border: 1px solid #fc8181;
      border-radius: 8px;
      padding: 16px;
      color: #c53030;
      font-size: 14px;
      margin-top: 16px;
    }

    .error-message.active {
      display: block;
    }

    /* Results Section */
    .results {
      display: none;
      margin-top: 20px;
    }

    .results-top-action {
      margin-bottom: 20px;
    }

    .new-comparison-top-button {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      background: white;
      border: 2px solid #4393CE;
      border-radius: 8px;
      color: #4393CE;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .new-comparison-top-button:hover {
      background: #4393CE;
      color: white;
    }

    /* CUPS Banner */
    .cups-display-banner {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 12px;
      margin-bottom: 20px;
      color: white;
    }

    .cups-display-icon {
      font-size: 32px;
    }

    .cups-display-content {
      flex: 1;
    }

    .cups-display-label {
      font-size: 12px;
      opacity: 0.9;
      margin-bottom: 4px;
    }

    .cups-display-value {
      font-size: 18px;
      font-weight: 700;
      font-family: 'Courier New', monospace;
      letter-spacing: 1px;
    }

    .cups-display-copy {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      border-radius: 6px;
      padding: 8px 12px;
      color: white;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .cups-display-copy:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    /* Results Header */
    .results-header {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 20px;
      text-align: center;
    }

    .power-analysis-results-header {
      background: linear-gradient(135deg, #f8fbff 0%, #fff 100%);
    }

    .savings-amount {
      font-size: 48px;
      font-weight: 700;
      margin-bottom: 8px;
      line-height: 1;
    }

    .savings-amount.positive {
      color: #27ae60;
    }

    .savings-amount.negative {
      color: #e53e3e;
    }

    .savings-amount.neutral {
      color: #718096;
    }

    .savings-label {
      font-size: 16px;
      color: #718096;
      margin-bottom: 8px;
    }

    .annual-savings {
      font-size: 14px;
      color: #4a5568;
      margin-bottom: 12px;
    }

    .method-badge {
      display: inline-block;
      background: #e6f3ff;
      color: #4393CE;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
    }

    .analysis-period {
      margin-top: 12px;
      font-size: 13px;
      color: #718096;
    }

    /* Recommendation Banner */
    .recommendation-banner {
      padding: 16px 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      text-align: center;
    }

    .recommendation-banner.optimal {
      background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
      color: white;
    }

    .recommendation-banner.optimize {
      background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
      color: white;
    }

    .recommendation-banner.urgent {
      background: linear-gradient(135deg, #fc8181 0%, #e53e3e 100%);
      color: white;
    }

    .recommendation-text {
      font-size: 16px;
      font-weight: 700;
    }

    /* Cost Comparison Grid */
    .cost-comparison-grid {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      gap: 16px;
      margin-bottom: 20px;
      align-items: stretch;
    }

    @media (max-width: 768px) {
      .cost-comparison-grid {
        grid-template-columns: 1fr;
      }
    }

    .cost-card {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 24px;
    }

    .cost-card.current {
      border-left: 4px solid #e53e3e;
    }

    .cost-card.suggested {
      border-left: 4px solid #48bb78;
    }

    .cost-card.arrow {
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: none;
      padding: 0;
    }

    .arrow-icon {
      font-size: 32px;
      color: #cbd5e0;
    }

    @media (max-width: 768px) {
      .cost-card.arrow {
        transform: rotate(90deg);
      }
    }

    .cost-card-header {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-weight: 600;
      color: #718096;
      margin-bottom: 12px;
    }

    .cost-card-value {
      font-size: 28px;
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 16px;
    }

    .cost-breakdown {
      border-top: 1px solid #e2e8f0;
      padding-top: 12px;
    }

    .cost-row {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      color: #4a5568;
      padding: 4px 0;
    }

    .cost-row.penalty span:last-child {
      color: #e53e3e;
      font-weight: 600;
    }

    /* Power Details Table */
    .power-details-section {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
    }

    .power-details-table {
      overflow-x: auto;
    }

    .power-table-header,
    .power-table-row {
      display: grid;
      grid-template-columns: 80px 1fr 1fr 1fr 1.5fr 120px;
      gap: 12px;
      align-items: center;
    }

    .power-table-header {
      background: #f7fafc;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 8px;
      font-size: 12px;
      font-weight: 700;
      color: #718096;
      text-transform: uppercase;
    }

    .power-table-row {
      padding: 12px 16px;
      border-bottom: 1px solid #e2e8f0;
      font-size: 14px;
      color: #2d3748;
    }

    .power-table-row:last-child {
      border-bottom: none;
    }

    .period-cell {
      font-weight: 700;
      color: #4393CE;
    }

    .suggested-value {
      color: #48bb78;
      font-weight: 600;
    }

    .utilization-bar {
      height: 8px;
      background: #e2e8f0;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 4px;
    }

    .utilization-fill {
      height: 100%;
      background: linear-gradient(90deg, #48bb78 0%, #38a169 100%);
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    .utilization-text {
      font-size: 11px;
      color: #718096;
    }

    .estado-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }

    .estado-badge.optimal {
      background: #c6f6d5;
      color: #276749;
    }

    .estado-badge.increase {
      background: #fed7d7;
      color: #c53030;
    }

    .estado-badge.decrease {
      background: #feebc8;
      color: #c05621;
    }

    .estado-badge.eliminate {
      background: #e2e8f0;
      color: #4a5568;
    }

    /* Penalties Summary */
    .penalties-summary {
      background: #fff5f5;
      border: 1px solid #fc8181;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
    }

    .penalties-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 16px;
    }

    .penalty-card {
      background: white;
      border: 1px solid #fc8181;
      border-radius: 8px;
      padding: 16px;
      text-align: center;
    }

    .penalty-period {
      font-size: 18px;
      font-weight: 700;
      color: #c53030;
      margin-bottom: 8px;
    }

    .penalty-amount {
      font-size: 20px;
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 4px;
    }

    .penalty-months {
      font-size: 12px;
      color: #718096;
    }

    /* Prices Info Footer */
    .prices-info-footer {
      background: #f7fafc;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
    }

    .prices-info-title {
      font-size: 14px;
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 12px;
    }

    .prices-info-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 8px;
      margin-bottom: 12px;
    }

    @media (max-width: 768px) {
      .prices-info-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    .price-info-item {
      display: flex;
      flex-direction: column;
      gap: 2px;
      text-align: center;
      font-size: 11px;
    }

    .price-info-item span:first-child {
      font-weight: 600;
      color: #4393CE;
    }

    .price-info-item span:last-child {
      color: #718096;
      font-family: 'Courier New', monospace;
    }

    .prices-info-source {
      font-size: 12px;
      color: #718096;
      text-align: center;
      padding-top: 12px;
      border-top: 1px solid #e2e8f0;
    }
  </style>
</head>
<body>

  <div class="power-analysis-layout">

    <!-- Main Content -->
    <main class="main-content power-analysis-main">

      <!-- Page Header -->
      <div class="page-header">
        <h1 class="page-title">‚ö° An√°lisis de Potencia</h1>
        <p class="page-subtitle">Optimiza la potencia contratada y detecta penalizaciones</p>
      </div>

      <!-- User Info Bar -->
      <div class="user-info-bar" id="userInfo">
        <span>üë§</span>
        <span id="userInfoText">Cargando usuario...</span>
      </div>

      <div id="power-analysis-section">

        <!-- Bill Question Section -->
        <div class="config-section bill-question-section">
          <div class="section-title">üìÑ ¬øTienes una factura a mano?</div>
          <div class="radio-group horizontal">
            <div class="radio-option">
              <input type="radio" id="has-bill-yes" name="has-bill" value="yes">
              <label for="has-bill-yes" class="radio-label">
                <div class="radio-label-title">‚úÖ S√≠, tengo factura</div>
                <div class="radio-label-desc">Subir√© un PDF para extraer datos</div>
              </label>
            </div>
            <div class="radio-option">
              <input type="radio" id="has-bill-no" name="has-bill" value="no" checked>
              <label for="has-bill-no" class="radio-label">
                <div class="radio-label-title">‚ùå No tengo factura</div>
                <div class="radio-label-desc">Ingresar√© el CUPS manualmente</div>
              </label>
            </div>
          </div>
        </div>

        <!-- PATH A: Manual Input (No Bill) -->
        <div class="manual-input-section" id="manualInputSection">

          <!-- CUPS Input -->
          <div class="config-section cups-input-section">
            <div class="section-title">üîå CUPS del Suministro</div>
            <div class="cups-input-wrapper">
              <input type="text"
                     id="cupsInput"
                     class="cups-input"
                     placeholder="Ej: ES0021000008926202HZ0F"
                     maxlength="22"
                     pattern="ES[0-9]{16}[A-Z]{2}[0-9A-Z]{0,2}">
              <div class="cups-input-hint">El CUPS debe comenzar con "ES" y tener 20-22 caracteres</div>
            </div>
          </div>

          <!-- Power Prices Section -->
          <div class="config-section power-prices-section">
            <div class="section-title-with-info">
              <div class="section-title">üí∞ Precio T√©rmino Potencia por Periodo (‚Ç¨/kW¬∑d√≠a)</div>
              <div class="info-badge" title="Precios seg√∫n BOE para Tarifa 3.0TD">‚ÑπÔ∏è BOE 3.0TD</div>
            </div>

            <div class="power-prices-note">
              <span class="note-icon">üìã</span>
              <span>Precios por defecto seg√∫n BOE (Tarifa 3.0TD). Puedes modificarlos seg√∫n tu contrato.</span>
            </div>

            <div class="power-prices-grid">
              <div class="power-price-field">
                <label for="precio_p1">P1</label>
                <input type="number" id="precio_p1" class="price-input" value="0.053858904" step="0.000000001" min="0">
              </div>
              <div class="power-price-field">
                <label for="precio_p2">P2</label>
                <input type="number" id="precio_p2" class="price-input" value="0.028086712" step="0.000000001" min="0">
              </div>
              <div class="power-price-field">
                <label for="precio_p3">P3</label>
                <input type="number" id="precio_p3" class="price-input" value="0.011678192" step="0.000000001" min="0">
              </div>
              <div class="power-price-field">
                <label for="precio_p4">P4</label>
                <input type="number" id="precio_p4" class="price-input" value="0.010086438" step="0.000000001" min="0">
              </div>
              <div class="power-price-field">
                <label for="precio_p5">P5</label>
                <input type="number" id="precio_p5" class="price-input" value="0.006378548" step="0.000000001" min="0">
              </div>
              <div class="power-price-field">
                <label for="precio_p6">P6</label>
                <input type="number" id="precio_p6" class="price-input" value="0.003716137" step="0.000000001" min="0">
              </div>
            </div>

            <button class="reset-prices-button" id="resetPricesButton" type="button">
              üîÑ Restablecer precios BOE
            </button>
          </div>

        </div>

        <!-- PATH B: File Upload (Has Bill) -->
        <div class="file-upload-section" id="fileUploadSection" style="display: none;">

          <div class="config-section">
            <div class="section-title">üì§ Subir Factura</div>
            <div class="section-subtitle">Extraeremos autom√°ticamente el CUPS y los precios de potencia</div>

            <div class="upload-area" id="uploadArea">
              <div class="upload-icon">üìÑ</div>
              <div class="upload-text">Arrastra la factura aqu√≠ o haz clic para seleccionar</div>
              <div class="upload-subtext">Solo archivos PDF (m√°x. 5 MB)</div>
            </div>

            <input type="file" id="fileInput" class="file-input" accept=".pdf">

            <div class="selected-file" id="selectedFile">
              <div class="file-icon">üìÑ</div>
              <div class="file-info">
                <div class="file-name" id="fileName"></div>
                <div class="file-size" id="fileSize"></div>
              </div>
              <button class="remove-file" id="removeFile" type="button">‚úï</button>
            </div>
          </div>

        </div>

        <!-- Analyze Button -->
        <button class="analyze-button" id="analyzeButton">
          ‚ö° Analizar Potencia
        </button>

      </div>

      <!-- Loading State -->
      <div class="loading" id="loading">
        <div class="spinner"></div>
        <div class="loading-text" id="loadingText">Analizando potencia del suministro...</div>
        <div class="loading-progress" id="loadingProgress"></div>
      </div>

      <!-- Error Message -->
      <div class="error-message" id="errorMessage"></div>

      <!-- Results Section -->
      <div class="results" id="results"></div>

    </main>

  </div>

  <script>
    // ============================================
    // POWER ANALYSIS TOOL - JavaScript
    // ============================================

    // Webhook URL for Power Analysis
    const POWER_ANALYSIS_WEBHOOK_URL = 'https://tunuevaenergia.com/webhook/power-analysis-crm';

    // BOE Default Prices (3.0TD)
    const BOE_DEFAULT_PRICES = {
      P1: 0.053858904,
      P2: 0.028086712,
      P3: 0.011678192,
      P4: 0.010086438,
      P5: 0.006378548,
      P6: 0.003716137
    };

    // Configuration
    const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5 MB
    const REQUEST_TIMEOUT = 120000; // 2 minutes

    // State
    let selectedFile = null;
    let currentUser = {
      user_id: null,
      name: 'Usuario',
      email: '',
      login: ''
    };
    let uploadController = null;

    // DOM Elements
    let hasBillYes, hasBillNo;
    let manualInputSection, fileUploadSection;
    let cupsInput;
    let priceInputs = {};
    let uploadArea, fileInput, selectedFileDiv, fileName, fileSize, removeFileBtn;
    let analyzeButton;
    let loading, loadingText, loadingProgress;
    let errorMessage;
    let results;

    // ============================================
    // INITIALIZATION
    // ============================================

    function initPowerAnalysis() {
      console.log('Initializing Power Analysis Tool...');

      // Get DOM elements
      hasBillYes = document.getElementById('has-bill-yes');
      hasBillNo = document.getElementById('has-bill-no');
      manualInputSection = document.getElementById('manualInputSection');
      fileUploadSection = document.getElementById('fileUploadSection');
      cupsInput = document.getElementById('cupsInput');

      // Price inputs
      for (let i = 1; i <= 6; i++) {
        priceInputs[`P${i}`] = document.getElementById(`precio_p${i}`);
      }

      // File upload elements
      uploadArea = document.getElementById('uploadArea');
      fileInput = document.getElementById('fileInput');
      selectedFileDiv = document.getElementById('selectedFile');
      fileName = document.getElementById('fileName');
      fileSize = document.getElementById('fileSize');
      removeFileBtn = document.getElementById('removeFile');

      // Action elements
      analyzeButton = document.getElementById('analyzeButton');
      const resetPricesButton = document.getElementById('resetPricesButton');

      // State elements
      loading = document.getElementById('loading');
      loadingText = document.getElementById('loadingText');
      loadingProgress = document.getElementById('loadingProgress');
      errorMessage = document.getElementById('errorMessage');
      results = document.getElementById('results');

      // Setup event listeners
      setupEventListeners();

      // Load user info
      loadUserInfo();

      console.log('Power Analysis Tool initialized');
    }

    function setupEventListeners() {
      // Bill question radio buttons
      hasBillYes.addEventListener('change', toggleInputMode);
      hasBillNo.addEventListener('change', toggleInputMode);

      // CUPS input validation
      cupsInput.addEventListener('input', validateCups);
      cupsInput.addEventListener('blur', validateCups);

      // Reset prices button
      const resetPricesButton = document.getElementById('resetPricesButton');
      if (resetPricesButton) {
        resetPricesButton.addEventListener('click', resetPricesToDefault);
      }

      // File upload handlers
      uploadArea.addEventListener('click', () => fileInput.click());

      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
      });

      uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
      });

      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleFileSelect(files[0]);
        }
      });

      fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
          handleFileSelect(e.target.files[0]);
        }
      });

      removeFileBtn.addEventListener('click', removeSelectedFile);

      // Analyze button
      analyzeButton.addEventListener('click', runPowerAnalysis);
    }

    // ============================================
    // INPUT MODE TOGGLE
    // ============================================

    function toggleInputMode() {
      const hasBill = hasBillYes.checked;

      if (hasBill) {
        // Show file upload, hide manual input
        manualInputSection.style.display = 'none';
        fileUploadSection.style.display = 'block';
        analyzeButton.disabled = !selectedFile;
      } else {
        // Show manual input, hide file upload
        manualInputSection.style.display = 'block';
        fileUploadSection.style.display = 'none';
        validateCups();
      }

      hideError();
    }

    // ============================================
    // CUPS VALIDATION
    // ============================================

    function validateCups() {
      const cups = cupsInput.value.trim().toUpperCase();
      cupsInput.value = cups;

      // CUPS validation: starts with ES, 20-22 characters
      const cupsRegex = /^ES[0-9]{16}[A-Z]{2}[0-9A-Z]{0,2}$/;
      const isValid = cupsRegex.test(cups);

      if (cups.length > 0) {
        if (isValid) {
          cupsInput.classList.remove('invalid');
          cupsInput.classList.add('valid');
        } else {
          cupsInput.classList.remove('valid');
          cupsInput.classList.add('invalid');
        }
      } else {
        cupsInput.classList.remove('valid', 'invalid');
      }

      // Enable/disable analyze button based on manual mode validation
      if (!hasBillYes.checked) {
        analyzeButton.disabled = !isValid;
      }

      return isValid;
    }

    // ============================================
    // PRICE HANDLING
    // ============================================

    function resetPricesToDefault() {
      for (const period in BOE_DEFAULT_PRICES) {
        const input = priceInputs[period];
        if (input) {
          input.value = BOE_DEFAULT_PRICES[period];
        }
      }
    }

    function getPowerPrices() {
      const prices = {};
      for (let i = 1; i <= 6; i++) {
        const input = priceInputs[`P${i}`];
        prices[`precio_p${i}`] = parseFloat(input.value) || BOE_DEFAULT_PRICES[`P${i}`];
      }
      return prices;
    }

    // ============================================
    // FILE HANDLING
    // ============================================

    function handleFileSelect(file) {
      // Validate file type
      if (file.type !== 'application/pdf') {
        showError('Por favor, selecciona un archivo PDF v√°lido.');
        return;
      }

      // Validate file size
      if (file.size > MAX_FILE_SIZE) {
        showError('El archivo es demasiado grande. El tama√±o m√°ximo es 5 MB.');
        return;
      }

      selectedFile = file;
      fileName.textContent = file.name;
      fileSize.textContent = formatFileSize(file.size);
      selectedFileDiv.classList.add('active');
      analyzeButton.disabled = false;
      hideError();
    }

    function removeSelectedFile() {
      selectedFile = null;
      fileInput.value = '';
      selectedFileDiv.classList.remove('active');
      analyzeButton.disabled = true;
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // ============================================
    // POWER ANALYSIS EXECUTION
    // ============================================

    async function runPowerAnalysis() {
      const hasBill = hasBillYes.checked;

      hideError();
      showLoading();

      try {
        let payload;

        if (hasBill) {
          // PATH B: File upload
          if (!selectedFile) {
            throw new Error('Por favor, selecciona un archivo PDF.');
          }

          loadingText.textContent = 'Leyendo factura...';

          const fileData = await readFileAsBase64(selectedFile);

          payload = {
            has_bill: true,
            file_data: fileData,
            file_name: selectedFile.name,
            user_name: currentUser.name,
            user_email: currentUser.email,
            user_id: currentUser.user_id
          };

        } else {
          // PATH A: Manual input
          if (!validateCups()) {
            throw new Error('Por favor, introduce un CUPS v√°lido.');
          }

          loadingText.textContent = 'Consultando datos del suministro...';

          const prices = getPowerPrices();

          payload = {
            has_bill: false,
            cups: cupsInput.value.trim().toUpperCase(),
            ...prices,
            user_name: currentUser.name,
            user_email: currentUser.email,
            user_id: currentUser.user_id
          };
        }

        loadingText.textContent = 'Analizando potencia...';
        loadingProgress.textContent = '';

        // Send request
        const response = await sendWithXHR(POWER_ANALYSIS_WEBHOOK_URL, payload, REQUEST_TIMEOUT);

        hideLoading();

        if (response.success) {
          displayResults(response);
        } else {
          throw new Error(response.error || 'Error al analizar la potencia.');
        }

      } catch (error) {
        hideLoading();
        showError(error.message || 'Error al procesar la solicitud.');
        console.error('Power Analysis Error:', error);
      }
    }

    function readFileAsBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const base64 = reader.result.split(',')[1];
          resolve(base64);
        };
        reader.onerror = () => reject(new Error('Error al leer el archivo.'));
        reader.readAsDataURL(file);
      });
    }

    function sendWithXHR(url, payload, timeoutMs) {
      return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();

        xhr.open('POST', url, true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.setRequestHeader('Accept', 'application/json');
        xhr.timeout = timeoutMs;

        xhr.upload.addEventListener('progress', (e) => {
          if (e.lengthComputable) {
            const percentComplete = Math.round((e.loaded / e.total) * 100);
            loadingProgress.textContent = `Enviando: ${percentComplete}%`;
          }
        });

        xhr.addEventListener('load', () => {
          if (xhr.status >= 200 && xhr.status < 300) {
            try {
              const data = JSON.parse(xhr.responseText);
              resolve(data);
            } catch (e) {
              reject(new Error('Error al procesar la respuesta del servidor.'));
            }
          } else {
            reject(new Error(`Error del servidor: ${xhr.status}`));
          }
        });

        xhr.addEventListener('error', () => {
          reject(new Error('Error de conexi√≥n. Verifica tu conexi√≥n a internet.'));
        });

        xhr.addEventListener('timeout', () => {
          reject(new Error('La solicitud ha tardado demasiado. Por favor, int√©ntalo de nuevo.'));
        });

        xhr.send(JSON.stringify(payload));
        uploadController = { abort: () => xhr.abort() };
      });
    }

    // ============================================
    // RESULTS DISPLAY
    // ============================================

    function displayResults(response) {
      const analysisResults = response.analysis_results || [];

      if (analysisResults.length === 0) {
        showError('No se encontraron datos para analizar este CUPS.');
        return;
      }

      const data = analysisResults[0];

      // Hide upload section
      document.getElementById('power-analysis-section').style.display = 'none';

      let html = '';

      // New Analysis Button
      html += `
        <div class="results-top-action">
          <button class="new-comparison-top-button" onclick="resetAnalysis()">
            <span>‚ûï</span>
            <span>Nuevo An√°lisis</span>
          </button>
        </div>`;

      // CUPS Banner
      html += `
        <div class="cups-display-banner">
          <div class="cups-display-icon">üîå</div>
          <div class="cups-display-content">
            <div class="cups-display-label">CUPS del Suministro</div>
            <div class="cups-display-value">${data.CUPS}</div>
          </div>
          <button class="cups-display-copy" onclick="copyCups('${data.CUPS}')">üìã Copiar</button>
        </div>`;

      // Savings Header
      const ahorro = data.Ahorro_Anual || 0;
      const savingsClass = ahorro > 0 ? 'positive' : (ahorro < 0 ? 'negative' : 'neutral');
      const savingsSign = ahorro > 0 ? '+' : '';

      html += `
        <div class="results-header power-analysis-results-header">
          <div class="savings-amount ${savingsClass}">${savingsSign}${ahorro.toFixed(2)} ‚Ç¨</div>
          <div class="savings-label">Ahorro Anual Potencial</div>
          <div class="annual-savings">Ahorro Mensual: ${(data.Ahorro_Mensual || 0).toFixed(2)} ‚Ç¨</div>
          <div class="method-badge">${data.Tarifa} - ${data.Tipo_Cliente}</div>
          <div class="analysis-period">üìÖ Per√≠odo: ${data.Periodo_Analisis}</div>
        </div>`;

      // Recommendation Banner
      const recomendacion = data.Recomendacion_General || '';
      let recClass = 'optimal';
      if (recomendacion.includes('URGENTE')) recClass = 'urgent';
      else if (recomendacion.includes('OPTIMIZAR')) recClass = 'optimize';

      html += `
        <div class="recommendation-banner ${recClass}">
          <div class="recommendation-text">${recomendacion}</div>
        </div>`;

      // Cost Comparison Cards
      html += `
        <div class="cost-comparison-grid">
          <div class="cost-card current">
            <div class="cost-card-header">
              <span>üìä</span>
              <span>Situaci√≥n Actual</span>
            </div>
            <div class="cost-card-value">${(data.Coste_Actual_Anual || 0).toFixed(2)} ‚Ç¨/a√±o</div>
            <div class="cost-breakdown">
              <div class="cost-row">
                <span>Potencia Fija:</span>
                <span>${(data.Coste_Potencia_Fija_Actual_Anual || 0).toFixed(2)} ‚Ç¨</span>
              </div>
              <div class="cost-row penalty">
                <span>Penalizaciones:</span>
                <span>${(data.Total_Penalizaciones_Anual || 0).toFixed(2)} ‚Ç¨</span>
              </div>
            </div>
          </div>

          <div class="cost-card arrow">
            <div class="arrow-icon">‚û°Ô∏è</div>
          </div>

          <div class="cost-card suggested">
            <div class="cost-card-header">
              <span>‚ú®</span>
              <span>Situaci√≥n Optimizada</span>
            </div>
            <div class="cost-card-value">${(data.Coste_Total_Sugerido_Anual || 0).toFixed(2)} ‚Ç¨/a√±o</div>
            <div class="cost-breakdown">
              <div class="cost-row">
                <span>Potencia Fija:</span>
                <span>${(data.Coste_Potencia_Fija_Sugerida_Anual || 0).toFixed(2)} ‚Ç¨</span>
              </div>
              <div class="cost-row penalty">
                <span>Penalizaciones:</span>
                <span>${(data.Total_Penalizaciones_Sugerido_Anual || 0).toFixed(2)} ‚Ç¨</span>
              </div>
            </div>
          </div>
        </div>`;

      // Power Period Details Table
      html += `
        <div class="power-details-section">
          <div class="section-title">‚ö° Detalle por Periodo de Potencia</div>
          <div class="power-details-table">
            <div class="power-table-header">
              <div class="power-table-cell">Periodo</div>
              <div class="power-table-cell">Contratada (kW)</div>
              <div class="power-table-cell">M√°xima (kW)</div>
              <div class="power-table-cell">Sugerida (kW)</div>
              <div class="power-table-cell">Utilizaci√≥n</div>
              <div class="power-table-cell">Estado</div>
            </div>`;

      const periods = ['P1', 'P2', 'P3', 'P4', 'P5', 'P6'];
      for (const period of periods) {
        const isActive = data[`${period}_Activo`] === 'SI';
        if (!isActive) continue;

        const contratada = data[`${period}_Contratada`] || 0;
        const maxima = data[`${period}_Maxima_Global`] || 0;
        const sugerida = data[`${period}_Sugerida`] || 0;
        const utilizacion = data[`${period}_Utilizacion_Pct`] || 0;
        const estado = data[`${period}_Estado`] || 'N/A';

        let estadoClass = 'optimal';
        let estadoIcon = '‚úÖ';
        if (estado === 'AUMENTAR') { estadoClass = 'increase'; estadoIcon = 'üî∫'; }
        else if (estado === 'REDUCIR') { estadoClass = 'decrease'; estadoIcon = 'üîª'; }
        else if (estado === 'ELIMINAR') { estadoClass = 'eliminate'; estadoIcon = '‚ùå'; }

        html += `
            <div class="power-table-row">
              <div class="power-table-cell period-cell">${period}</div>
              <div class="power-table-cell">${contratada.toFixed(2)}</div>
              <div class="power-table-cell">${maxima.toFixed(2)}</div>
              <div class="power-table-cell suggested-value">${sugerida.toFixed(2)}</div>
              <div class="power-table-cell">
                <div class="utilization-bar">
                  <div class="utilization-fill" style="width: ${Math.min(utilizacion, 100)}%"></div>
                </div>
                <span class="utilization-text">${utilizacion.toFixed(1)}%</span>
              </div>
              <div class="power-table-cell">
                <span class="estado-badge ${estadoClass}">${estadoIcon} ${estado}</span>
              </div>
            </div>`;
      }

      html += `
          </div>
        </div>`;

      // Penalties Summary (if any)
      if ((data.Total_Penalizaciones_Anual || 0) > 0) {
        html += `
        <div class="penalties-summary">
          <div class="section-title">‚ö†Ô∏è Resumen de Penalizaciones</div>
          <div class="penalties-grid">`;

        for (const period of periods) {
          const penalizacion = data[`${period}_Penalizacion_Anual`] || 0;
          const meses = data[`${period}_Meses_Con_Penalizacion`] || 0;
          if (penalizacion > 0) {
            html += `
            <div class="penalty-card">
              <div class="penalty-period">${period}</div>
              <div class="penalty-amount">${penalizacion.toFixed(2)} ‚Ç¨</div>
              <div class="penalty-months">${meses} meses afectados</div>
            </div>`;
          }
        }

        html += `
          </div>
        </div>`;
      }

      // Price Info Footer
      const preciosUtilizados = response.precios_utilizados || {};
      html += `
        <div class="prices-info-footer">
          <div class="prices-info-title">üí∞ Precios T√©rmino Potencia Utilizados (‚Ç¨/kW¬∑d√≠a)</div>
          <div class="prices-info-grid">
            ${Object.entries(preciosUtilizados).map(([period, price]) =>
              `<div class="price-info-item"><span>${period}:</span><span>${price.toFixed(9)}</span></div>`
            ).join('')}
          </div>
          <div class="prices-info-source">
            ${response.is_manual_input ? 'üìù Precios ingresados manualmente' : 'üìÑ Precios extra√≠dos de la factura'}
          </div>
        </div>`;

      results.innerHTML = html;
      results.style.display = 'block';
    }

    function resetAnalysis() {
      // Show upload section again
      document.getElementById('power-analysis-section').style.display = 'block';

      // Clear results
      results.innerHTML = '';
      results.style.display = 'none';

      // Reset form
      cupsInput.value = '';
      cupsInput.classList.remove('valid', 'invalid');
      removeSelectedFile();
      resetPricesToDefault();

      // Reset to manual mode
      hasBillNo.checked = true;
      toggleInputMode();

      hideError();
    }

    function copyCups(cups) {
      navigator.clipboard.writeText(cups).then(() => {
        const copyBtn = document.querySelector('.cups-display-copy');
        const originalText = copyBtn.innerHTML;
        copyBtn.innerHTML = '‚úì Copiado';
        setTimeout(() => {
          copyBtn.innerHTML = originalText;
        }, 2000);
      });
    }

    // ============================================
    // UI HELPERS
    // ============================================

    function showLoading() {
      loading.classList.add('active');
      analyzeButton.disabled = true;
    }

    function hideLoading() {
      loading.classList.remove('active');
      // Re-enable based on current mode
      if (hasBillYes.checked) {
        analyzeButton.disabled = !selectedFile;
      } else {
        validateCups();
      }
    }

    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.classList.add('active');
    }

    function hideError() {
      errorMessage.textContent = '';
      errorMessage.classList.remove('active');
    }

    // ============================================
    // USER INFO
    // ============================================

    async function loadUserInfo() {
      try {
        const response = await fetch('/web/session/get_session_info', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({})
        });

        const data = await response.json();

        if (data.result && data.result.uid) {
          currentUser = {
            user_id: data.result.uid,
            name: data.result.name || 'Usuario',
            email: data.result.username || '',
            login: data.result.username || ''
          };

          const userInfoText = document.getElementById('userInfoText');
          if (userInfoText) {
            userInfoText.textContent = currentUser.name;
          }
        }
      } catch (error) {
        console.warn('Could not load user info:', error);
      }
    }

    // ============================================
    // INITIALIZE ON LOAD
    // ============================================

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initPowerAnalysis);
    } else {
      initPowerAnalysis();
    }
  </script>

</body>
</html>
