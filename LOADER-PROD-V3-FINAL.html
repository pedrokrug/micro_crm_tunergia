<!--
    Tunergia CRM - Production Loader v3.1.0

    Original loader + Comparador pill switch

    Files loaded:
    - src_prod/styles.css (CSS styling)
    - src_prod/tunergia-core.js (Config, State, Utils)
    - src_prod/tunergia-api.js (API calls)
    - src_prod/tunergia-ui.js (UI, Events, Main)
    - modules/comparador/* (on demand)

    Last updated: 2025-12-22
    Version: 3.1.0
-->

<!-- CSS Styles -->
<link rel="stylesheet" href="https://rawcdn.githack.com/pedrokrug/micro_crm_tunergia/5457bf6/src_prod/styles.css">
<link rel="stylesheet" href="https://rawcdn.githack.com/pedrokrug/micro_crm_tunergia/70afbf9/src_prod/modules/comparador/comparador.css">

<!-- HTML Content -->
<div class="tunergia-dashboard">

    <!-- Tool Switcher Pill - Top of everything -->
    <div style="text-align: center; padding: 8px 0 8px 0;">
        <div class="tool-switcher-pill">
            <button class="pill-btn active" onclick="showContratos()">üìä Contratos</button>
            <button class="pill-btn" onclick="showComparador()">‚ö° Comparador</button>
        </div>
    </div>

    <div class="loading-overlay" id="dashboardLoading">
        <div class="loading-spinner"></div>
        <p class="loading-text">Cargando datos del dashboard...</p>
    </div>

    <div class="error-banner" id="dashboardError">
        <span class="error-icon">‚ö†Ô∏è</span>
        <span class="error-text" id="errorText">Ha ocurrido un error al cargar los datos.</span>
    </div>

    <div class="user-banner" id="userBanner">
        <div class="user-info">
            <div class="user-avatar" id="userAvatar">--</div>
            <div class="user-details">
                <h3 id="userName">Cargando...</h3>
                <p id="userEmail">Cargando informaci√≥n del usuario...</p>
            </div>
        </div>
        <div class="user-id-badge" id="userIdBadge">ID: ---</div>
    </div>

    <!-- CONTRATOS CONTENT -->
    <div id="contratosView">
    <div class="dashboard-header">
        <div class="header-left">
            <h1>Bienvenido, <span id="welcomeName">Usuario</span></h1>
            <p>Gestiona tus contratos, centraliza tu informaci√≥n y haz comparativas</p>
        </div>
        <div class="header-right">
            <div class="alert-badge">
                <span class="alert-icon">‚ö°</span>
                <span>¬°Atenci√≥n! Nuevas actualizaciones de precio disponibles</span>
            </div>
            <button class="notification-btn" title="Notificaciones">üîî</button>
        </div>
    </div>


    <div class="date-filters">
        <div class="filter-buttons">
            <button class="filter-btn" data-days="365">12 meses</button>
            <button class="filter-btn" data-days="180">6 meses</button>
            <button class="filter-btn active" data-days="30">30 d√≠as</button>
            <button class="filter-btn" data-days="7">7 d√≠as</button>
        </div>
        <span style="font-size: 12px; color: #718096;">‚Üê Filtro para estad√≠sticas</span>
    </div>


    <div class="stats-grid" style="margin-bottom: 12px;">
        <div class="stat-card centered">
            <div class="stat-label">Contratos En Tramitaci√≥n</div>
            <div class="stat-value-centered">
                <span id="statTramitados">--</span>
            </div>
            <div class="stat-change neutral" id="changeTramitados">
                <span class="change-icon">‚è≥</span>
                <span>pendientes actualmente</span>
            </div>
        </div>

        <div class="stat-card centered">
            <div class="stat-label">Contratos Activados</div>
            <div class="stat-value-centered">
                <span id="statActivados">--</span>
            </div>
            <div class="stat-change positive" id="changeActivados">
                <span class="change-icon">‚Üë</span>
                <span>--% vs per√≠odo anterior</span>
            </div>
        </div>

        <div class="stat-card centered">
            <div class="stat-label">Contratos Bajas</div>
            <div class="stat-value-centered">
                <span id="statBajas">--</span>
            </div>
            <div class="stat-change negative" id="changeBajas">
                <span class="change-icon">‚Üì</span>
                <span>--% vs per√≠odo anterior</span>
            </div>
        </div>
    </div>


    <div class="stats-grid">
        <div class="stat-card centered">
            <div class="stat-label">kWh En Tramitaci√≥n</div>
            <div class="stat-value-centered">
                <span id="statKwhTramitacion">--</span>
            </div>
            <div class="stat-change neutral" id="changeKwhTramitacion">
                <span class="change-icon">‚è≥</span>
                <span>pendiente</span>
            </div>
        </div>

        <div class="stat-card centered">
            <div class="stat-label">kWh Activados</div>
            <div class="stat-value-centered">
                <span id="statKwhActivados">--</span>
            </div>
            <div class="stat-change positive" id="changeKwhActivados">
                <span class="change-icon">‚ö°</span>
                <span>--% vs per√≠odo anterior</span>
            </div>
        </div>

        <div class="stat-card centered">
            <div class="stat-label">kWh Bajas</div>
            <div class="stat-value-centered">
                <span id="statKwhBajas">--</span>
            </div>
            <div class="stat-change negative" id="changeKwhBajas">
                <span class="change-icon">‚Üì</span>
                <span>--% vs per√≠odo anterior</span>
            </div>
        </div>
    </div>


    <div class="contracts-section">
        <div class="contracts-header">
            <div class="contracts-title">
                <div>
                    <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                        <h2>Todos tus Contratos</h2>
                        <span class="contracts-count" id="totalContracts">0 Contratos</span>
                        <span class="contracts-count" id="filteredCount" style="display: none; background: #fef3c7; color: #92400e;"></span>
                    </div>
                    <p>Listado completo de tus clientes y contratos.</p>
                </div>
            </div>
            <div class="contracts-actions">
                <div id="selectionInfo" style="display: none; align-items: center; gap: 8px; padding: 8px 12px; background: #ebf8ff; border-radius: 6px; margin-right: 8px;">
                    <span id="selectedCount" style="font-weight: 600; color: #2b6cb0;">0 seleccionados</span>
                    <button id="selectAllContracts" class="action-btn" style="padding: 4px 8px; font-size: 11px; display: none;">
                        Seleccionar todos los <span id="selectAllCount">0</span> contratos
                    </button>
                </div>
                <button class="action-btn" id="exportBtn" disabled="" title="Selecciona contratos para exportar">
                    <span>üì§</span> Exportar
                </button>
                <button class="action-btn primary" id="createBtn">
                    <span>+</span> Crear Contrato
                </button>
            </div>
        </div>


        <div class="list-date-filter" style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px; padding: 12px 16px; background: #f7fafc; border-radius: 8px; flex-wrap: wrap;">
            <span style="font-size: 13px; font-weight: 600; color: #4a5568;">üìÖ Filtrar por fecha:</span>
            <div style="display: flex; align-items: center; gap: 8px;">
                <label style="font-size: 12px; color: #718096;">Desde</label>
                <input type="date" id="listDateFrom" style="padding: 6px 10px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 13px;">
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
                <label style="font-size: 12px; color: #718096;">Hasta</label>
                <input type="date" id="listDateTo" style="padding: 6px 10px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 13px;">
            </div>
            <button id="applyDateFilter" class="action-btn" style="padding: 6px 12px; font-size: 12px;">Aplicar</button>
            <button id="clearDateFilter" class="action-btn" style="padding: 6px 12px; font-size: 12px;">Limpiar</button>
            <div style="margin-left: auto; display: flex; align-items: center; gap: 8px;">
                <label style="font-size: 12px; color: #718096;">Ver</label>
                <select id="itemsPerPage" style="padding: 6px 10px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 13px;">
                    <option value="10">10</option>
                    <option value="25">25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
                <span style="font-size: 12px; color: #718096;">por p√°gina</span>
            </div>
        </div>

        <div class="contracts-filters">
            <div class="tab-buttons">
                <button class="tab-btn active" data-filter="all">Todos</button>
                <button class="tab-btn" data-filter="tramitado">En Tramitaci√≥n</button>
                <button class="tab-btn" data-filter="oportunidad">Oportunidad</button>
                <button class="tab-btn" data-filter="activado">Activados</button>
                <button class="tab-btn" data-filter="baja">Bajas</button>
            </div>
            <div class="search-filters">
                <div class="search-input">
                    <span class="search-icon">üîç</span>
                    <input type="text" id="searchInput" placeholder="Buscar cliente, CUPS, comercializadora...">
                </div>
                <button class="filters-btn">
                    <span>‚ò∞</span> Filtros
                </button>
            </div>
        </div>

        <div class="contracts-table-container">
            <table class="contracts-table">
                <thead>
                    <tr>
                        <th class="checkbox-cell"><input type="checkbox" id="selectAll"></th>
                        <th class="sortable" data-sort="id">ID <span class="sort-icon">‚Üï</span></th>
                        <th class="sortable" data-sort="cliente">Nombre <span class="sort-icon">‚Üï</span></th>
                        <th class="sortable" data-sort="estado">Estado <span class="sort-icon">‚Üï</span></th>
                        <th class="sortable" data-sort="tipo">Comercializadora <span class="sort-icon">‚Üï</span></th>
                        <th>Tarifa</th>
                        <th class="sortable" data-sort="consumo">Consumo <span class="sort-icon">‚Üï</span></th>
                        <th>CUPS</th>
                        <th class="sortable" data-sort="fecha">Fecha Creaci√≥n <span class="sort-icon">‚Üï</span></th>
                        <th class="action-cell"></th>
                    </tr>
                </thead>
                <tbody id="contractsTableBody">

                </tbody>
            </table>
        </div>

        <div class="empty-state" id="emptyState" style="display: none;">
            <div class="empty-icon">üìã</div>
            <h3>No hay contratos</h3>
            <p>No se encontraron contratos para este comercial.</p>
        </div>

        <div class="pagination" id="pagination">
            <div class="pagination-info">
                <span id="paginationInfo">1 of 1</span>
                <span style="margin-left: 16px; color: #718096; font-size: 12px;" id="loadedInfo">Mostrando 0 de 0</span>
            </div>
            <div class="pagination-controls" style="display: flex; align-items: center; gap: 12px;">
                <button class="pagination-btn" id="prevPage" disabled="">&lt;</button>
                <button class="pagination-btn" id="nextPage">Avanzar</button>
            </div>
        </div>
    </div>


    <div class="contract-detail-modal" id="contractDetailModal">
        <div class="contract-detail-overlay" id="contractDetailOverlay"></div>
        <div class="contract-detail-container">
            <div class="contract-detail-header">
                <button class="back-btn" id="backToListBtn">
                    <span>‚Üê</span> Volver al listado
                </button>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <button class="action-btn primary" id="renovarContractBtn" style="display: none;">
                        <span>üîÑ</span> RENOVAR
                    </button>
                    <div class="contract-id-badge" id="modalContractId">ID: ---</div>
                </div>
            </div>

            <div class="contract-detail-loading" id="contractDetailLoading">
                <div class="loading-spinner"></div>
                <p>Cargando datos del contrato...</p>
            </div>

            <div class="contract-detail-error" id="contractDetailError">
                <span>‚ö†Ô∏è</span>
                <span id="contractDetailErrorText">Error al cargar los datos</span>
            </div>

            <div class="contract-detail-content" id="contractDetailContent">

                <div class="detail-tabs">
                    <button class="detail-tab active" data-tab="cliente">Datos del Cliente</button>
                    <button class="detail-tab" data-tab="historial">Historial</button>
                </div>


                <div class="detail-tab-content active" id="tabCliente">
                    <div class="detail-section">
                        <h3>Datos del Contrato</h3>
                        <p class="section-subtitle">Informaci√≥n General, Documentos y Tr√°mite de Contrataci√≥n.</p>
                    </div>


                    <div class="detail-section">
                        <h4>Datos Personales</h4>
                        <div class="detail-grid">
                            <div class="detail-field">
                                <label>Nombre Completo</label>
                                <div class="field-value" id="detailNombre">-</div>
                            </div>
                            <div class="detail-field">
                                <label>Tipo de Cliente</label>
                                <div class="field-value" id="detailTipoCliente">-</div>
                            </div>
                            <div class="detail-field">
                                <label>Correo</label>
                                <div class="field-value"><span class="field-icon">‚úâÔ∏è</span> <span id="detailCorreo">-</span></div>
                            </div>
                            <div class="detail-field">
                                <label>M√≥vil</label>
                                <div class="field-value"><span class="field-icon">üì±</span> <span id="detailMovil">-</span></div>
                            </div>
                            <div class="detail-field">
                                <label>DNI/CIF</label>
                                <div class="field-value"><span class="field-icon">ü™™</span> <span id="detailDNI">-</span></div>
                            </div>
                            <div class="detail-field">
                                <label>IBAN</label>
                                <div class="field-value"><span class="field-icon">üè¶</span> <span id="detailIBAN">-</span></div>
                            </div>
                            <div class="detail-field full-width">
                                <label>Direcci√≥n Fiscal</label>
                                <div class="field-value"><span class="field-icon">üìç</span> <span id="detailDireccion">-</span></div>
                            </div>
                            <div class="detail-field">
                                <label>C√≥digo Postal</label>
                                <div class="field-value"><span class="field-icon">üìÆ</span> <span id="detailCP">-</span></div>
                            </div>
                            <div class="detail-field">
                                <label>Poblaci√≥n</label>
                                <div class="field-value"><span class="field-icon">üèòÔ∏è</span> <span id="detailPoblacion">-</span></div>
                            </div>
                            <div class="detail-field">
                                <label>Provincia</label>
                                <div class="field-value"><span class="field-icon">üèõÔ∏è</span> <span id="detailProvincia">-</span></div>
                            </div>
                        </div>
                    </div>


                    <div class="detail-section">
                        <h4>Datos de Suministro</h4>
                        <div class="detail-grid">
                            <div class="detail-field">
                                <label>Nombre Completo</label>
                                <div class="field-value" id="detailNombreSuministro">-</div>
                            </div>
                            <div class="detail-field">
                                <label>DNI</label>
                                <div class="field-value"><span class="field-icon">ü™™</span> <span id="detailDNISuministro">-</span></div>
                            </div>
                            <div class="detail-field full-width">
                                <label>Direcci√≥n</label>
                                <div class="field-value"><span class="field-icon">üìç</span> <span id="detailDireccionSuministro">-</span></div>
                            </div>
                            <div class="detail-field">
                                <label>Poblaci√≥n</label>
                                <div class="field-value"><span class="field-icon">üèòÔ∏è</span> <span id="detailPoblacionSuministro">-</span></div>
                            </div>
                            <div class="detail-field">
                                <label>C√≥digo Postal</label>
                                <div class="field-value"><span class="field-icon">üìÆ</span> <span id="detailCPSuministro">-</span></div>
                            </div>
                            <div class="detail-field">
                                <label>Provincia</label>
                                <div class="field-value"><span class="field-icon">üèõÔ∏è</span> <span id="detailProvinciaSuministro">-</span></div>
                            </div>
                            <div class="detail-field">
                                <label>Comercializadora Saliente</label>
                                <div class="field-value"><span class="field-icon">‚ö°</span> <span id="detailComercializadoraSaliente">-</span></div>
                            </div>
                            <div class="detail-field">
                                <label>CUPS</label>
                                <div class="field-value cups-value"><span class="field-icon">üîå</span> <span id="detailCUPS">-</span></div>
                            </div>
                        </div>
                    </div>


                    <div class="detail-section">
                        <h4>Datos de Contrataci√≥n</h4>
                        <div class="detail-grid">
                            <div class="detail-field">
                                <label>Comercializadora Elegida</label>
                                <div class="field-value"><span class="field-icon">‚ö°</span> <span id="detailComercializadora">-</span></div>
                            </div>
                            <div class="detail-field">
                                <label>Concepto</label>
                                <div class="field-value"><span class="field-icon">üìã</span> <span id="detailConcepto">-</span></div>
                            </div>
                            <div class="detail-field">
                                <label>Seleccionar Tarifa</label>
                                <div class="field-value" id="detailTarifa">-</div>
                            </div>
                            <div class="detail-field">
                                <label>Tarifa de Acceso</label>
                                <div class="field-value" id="detailTarifaAcceso">-</div>
                            </div>
                            <div class="detail-field">
                                <label>Tipo de Contrataci√≥n</label>
                                <div class="field-value" id="detailTipoContratacion">-</div>
                            </div>
                            <div class="detail-field">
                                <label>C√≥digo CNAE</label>
                                <div class="field-value"><span class="field-icon">üè¢</span> <span id="detailCNAE">-</span></div>
                            </div>
                            <div class="detail-field">
                                <label>Firma Digital</label>
                                <div class="field-value" id="detailFirmaDigital">-</div>
                            </div>
                            <div class="detail-field">
                                <label>Factura Electr√≥nica</label>
                                <div class="field-value" id="detailFacturaElectronica">-</div>
                            </div>
                            <div class="detail-field">
                                <label>Cambio de Comercializadora</label>
                                <div class="field-value" id="detailCambioComercializadora">-</div>
                            </div>
                            <div class="detail-field">
                                <label>Autoconsumo</label>
                                <div class="field-value" id="detailAutoconsumo">-</div>
                            </div>
                            <div class="detail-field">
                                <label>Futura Activaci√≥n</label>
                                <div class="field-value" id="detailFuturaActivacion">-</div>
                            </div>
                            <div class="detail-field">
                                <label>Fecha de Activaci√≥n</label>
                                <div class="field-value"><span class="field-icon">üìÖ</span> <span id="detailFechaActivacion">-</span></div>
                            </div>
                            <div class="detail-field">
                                <label>Fecha de Cancelaci√≥n</label>
                                <div class="field-value"><span class="field-icon">üìÖ</span> <span id="detailFechaCancelacion">-</span></div>
                            </div>
                            <div class="detail-field">
                                <label>Comercial</label>
                                <div class="field-value"><span class="field-icon">üë§</span> <span id="detailComercial">-</span></div>
                            </div>
                            <div class="detail-field">
                                <label>KAM</label>
                                <div class="field-value"><span class="field-icon">üëî</span> <span id="detailKAM">-</span></div>
                            </div>
                        </div>
                    </div>


                    <div class="detail-section">
                        <h4>Datos de Consumo</h4>
                        <div class="consumo-table-container">
                            <table class="consumo-table">
                                <thead>
                                    <tr>
                                        <th></th>
                                        <th>P1</th>
                                        <th>P2</th>
                                        <th>P3</th>
                                        <th>P4</th>
                                        <th>P5</th>
                                        <th>P6</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="row-label">Potencia Contratada (kW)</td>
                                        <td id="detailPotP1">-</td>
                                        <td id="detailPotP2">-</td>
                                        <td id="detailPotP3">-</td>
                                        <td id="detailPotP4">-</td>
                                        <td id="detailPotP5">-</td>
                                        <td id="detailPotP6">-</td>
                                    </tr>
                                    <tr>
                                        <td class="row-label">Consumo (kWh)</td>
                                        <td id="detailConsP1">-</td>
                                        <td id="detailConsP2">-</td>
                                        <td id="detailConsP3">-</td>
                                        <td id="detailConsP4">-</td>
                                        <td id="detailConsP5">-</td>
                                        <td id="detailConsP6">-</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="consumo-summary">
                            <div class="consumo-total">
                                <span class="label">Consumo Total Anual:</span>
                                <span class="value" id="detailConsumoTotal">-</span>
                            </div>
                        </div>
                    </div>


                    <div class="detail-section">
                        <h4>Documentos</h4>
                        <div class="documents-info">
                            <p>Sube aqu√≠ todos los documentos <strong>obligatorios</strong> para la tramitaci√≥n.</p>
                            <div class="documents-list" id="detailDocumentos">
                                <p class="no-docs">No hay documentos adjuntos</p>
                            </div>
                        </div>
                    </div>


                    <div class="detail-section">
                        <h4>Observaciones</h4>
                        <div class="observations-box" id="detailObservaciones">
                            Sin observaciones
                        </div>
                    </div>
                </div>


                <div class="detail-tab-content" id="tabHistorial">
                    <div class="detail-section">
                        <h3>Historial del Contrato</h3>
                        <p class="section-subtitle">Registro de cambios y eventos del contrato.</p>
                    </div>

                    <div class="history-timeline" id="historyTimeline">
                        <p class="no-history">Cargando historial...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <div class="contract-detail-modal" id="createContractModal">
        <div class="contract-detail-overlay" id="createContractOverlay"></div>
        <div class="contract-detail-container">
            <div class="contract-detail-header">
                <button class="back-btn" id="backFromCreateBtn">
                    <span>‚Üê</span> Volver al listado
                </button>
                <div class="contract-id-badge" style="background: #38a169;">
                    <span>‚ú® Nuevo Contrato</span>
                </div>
            </div>

            <div class="contract-detail-content" style="display: block;">
                <form id="createContractForm">

                    <div class="detail-section">
                        <h4>Datos Personales</h4>
                        <div class="detail-grid">
                            <div class="detail-field">
                                <label>Nombre Completo *</label>
                                <input type="text" name="nombre_cliente" class="form-input" required="">
                            </div>
                            <div class="detail-field">
                                <label>Tipo de Cliente *</label>
                                <select name="tipo_empresa" class="form-input" required id="createTipoCliente">
                                    <option value="">Seleccionar...</option>
                                    <option value="PARTICULAR">Particular</option>
                                    <option value="AUTONOMO">Aut√≥nomo</option>
                                    <option value="EMPRESA">Empresa</option>
                                    <option value="CCPP">CCPP (Comunidad de Propietarios)</option>
                                </select>
                            </div>
                            <div class="detail-field">
                                <label>Correo Electr√≥nico *</label>
                                <input type="email" name="email" class="form-input" required="">
                            </div>
                            <div class="detail-field">
                                <label>Tel√©fono M√≥vil *</label>
                                <input type="tel" name="movil" class="form-input" required="">
                            </div>
                            <div class="detail-field">
                                <label>DNI/NIF/CIF *</label>
                                <input type="text" name="nif" class="form-input" required="">
                            </div>
                            <div class="detail-field">
                                <label>IBAN</label>
                                <input type="text" name="iban_contrato" class="form-input" placeholder="ES00 0000 0000 0000 0000 0000">
                            </div>
                            <div class="detail-field full-width">
                                <label>Direcci√≥n Fiscal</label>
                                <input type="text" name="direccion" class="form-input">
                            </div>
                            <div class="detail-field">
                                <label>C√≥digo Postal</label>
                                <input type="text" name="cp" class="form-input" maxlength="5">
                            </div>
                            <div class="detail-field">
                                <label>Poblaci√≥n</label>
                                <input type="text" name="poblacion" class="form-input">
                            </div>
                            <div class="detail-field">
                                <label>Provincia</label>
                                <input type="text" name="provincia" class="form-input">
                            </div>
                        </div>
                    </div>


                    <div class="detail-section">
                        <h4>Datos de Suministro</h4>
                        <div class="detail-grid">
                            <div class="detail-field full-width">
                                <label><input type="checkbox" id="sameAsPersonal"> Mismos datos que titular</label>
                            </div>
                            <div class="detail-field">
                                <label>Nombre Completo</label>
                                <input type="text" name="persona_contacto" class="form-input">
                            </div>
                            <div class="detail-field">
                                <label>DNI</label>
                                <input type="text" name="persona_contacto_nif" class="form-input">
                            </div>
                            <div class="detail-field">
                                <label>Comercializadora Saliente</label>
                                <input type="text" name="comercializadora_saliente" class="form-input">
                            </div>
                            <div class="detail-field full-width">
                                <label>Direcci√≥n de Suministro</label>
                                <input type="text" name="direccion_suministro" class="form-input">
                            </div>
                            <div class="detail-field">
                                <label>C√≥digo Postal</label>
                                <input type="text" name="cp_suministro" class="form-input" maxlength="5">
                            </div>
                            <div class="detail-field">
                                <label>Poblaci√≥n</label>
                                <input type="text" name="poblacion_suministro" class="form-input">
                            </div>
                            <div class="detail-field">
                                <label>Provincia</label>
                                <input type="text" name="provincia_suministro" class="form-input">
                            </div>
                            <div class="detail-field full-width">
                                <label>CUPS *</label>
                                <div style="display: flex; gap: 8px;">
                                    <input type="text" name="cups" id="cupsInput" class="form-input" required="" maxlength="22" placeholder="ES0000000000000000XX" style="flex: 1;">
                                    <button type="button" class="action-btn" id="extractSipsBtn" style="white-space: nowrap;">
                                        <span>üìä</span> Extrair datos SIPS
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>


                    <div class="detail-section">
                        <h4>Datos de Contrataci√≥n</h4>
                        <div class="detail-grid">
                            <div class="detail-field">
                                <label>Comercializadora *</label>
                                <select name="comercializadora" class="form-input" required="" id="createComercializadora">
                                    <option value="">Cargando...</option>
                                </select>
                                <small style="color: #718096; font-size: 11px;">Se carga desde base de datos</small>
                            </div>
                            <div class="detail-field">
                                <label>Producto</label>
                                <select name="concepto" class="form-input" id="createProducto" disabled="">
                                    <option value="">Seleccionar comercializadora primero...</option>
                                </select>
                                <small style="color: #718096; font-size: 11px;">Se carga tras seleccionar comercializadora y tarifa</small>
                            </div>
                            <div class="detail-field">
                                <label>Tarifa de Acceso *</label>
                                <select name="tarifa_acceso" class="form-input" required="" id="createTarifaAcceso">
                                    <option value="">Seleccionar...</option>
                                    <option value="2.0TD">2.0TD</option>
                                    <option value="3.0TD">3.0TD</option>
                                    <option value="6.1TD">6.1TD</option>
                                    <option value="RL.1">RL.1</option>
                                    <option value="RL.2">RL.2</option>
                                    <option value="RL.3">RL.3</option>
                                </select>
                            </div>
                            <div class="detail-field">
                                <label>C√≥digo CNAE</label>
                                <input type="text" name="cnae_actividad" class="form-input">
                            </div>
                            <div class="detail-field">
                                <label>Firma Digital</label>
                                <select name="firma_digital" class="form-input">
                                    <option value="0">No</option>
                                    <option value="1">S√≠</option>
                                </select>
                            </div>
                            <div class="detail-field">
                                <label>Factura Electr√≥nica</label>
                                <select name="fact_electronica" class="form-input">
                                    <option value="">No</option>
                                    <option value="SI">S√≠</option>
                                </select>
                            </div>
                            <div class="detail-field">
                                <label>Autoconsumo</label>
                                <select name="luz_autoconsumo" class="form-input">
                                    <option value="">No</option>
                                    <option value="SI">S√≠</option>
                                </select>
                            </div>
                            <div class="detail-field">
                                <label>Tipo Contrataci√≥n</label>
                                <select name="tipo_contratacion" class="form-input" id="createTipoContratacion">
                                    <option value="">Nueva alta</option>
                                    <option value="RENOVACION">Renovaci√≥n</option>
                                    <option value="CAMBIO">Cambio comercializadora</option>
                                </select>
                            </div>
                            <div class="detail-field full-width">
                                <label style="margin-bottom: 8px; text-align: center; display: block;">Opciones Adicionales</label>
                                <div style="display: flex; gap: 20px; justify-content: center;">
                                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                        <input type="checkbox" name="cambio_titular" value="SI" style="width: 18px; height: 18px;">
                                        <span>Cambio de Titular</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                        <input type="checkbox" name="cambio_potencia" value="SI" style="width: 18px; height: 18px;">
                                        <span>Cambio de Potencia</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>


                    <div class="detail-section">
                        <h4>Datos de Consumo</h4>
                        <table class="consumo-table">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th>P1</th>
                                    <th>P2</th>
                                    <th>P3</th>
                                    <th>P4</th>
                                    <th>P5</th>
                                    <th>P6</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>Potencia (kW)</strong></td>
                                    <td><input type="number" step="0.01" name="potencia_contratada_1" class="form-input small"></td>
                                    <td><input type="number" step="0.01" name="potencia_contratada_2" class="form-input small"></td>
                                    <td><input type="number" step="0.01" name="potencia_contratada_3" class="form-input small"></td>
                                    <td><input type="number" step="0.01" name="potencia_contratada_4" class="form-input small"></td>
                                    <td><input type="number" step="0.01" name="potencia_contratada_5" class="form-input small"></td>
                                    <td><input type="number" step="0.01" name="potencia_contratada_6" class="form-input small"></td>
                                </tr>
                                <tr>
                                    <td><strong>Consumo (kWh)</strong></td>
                                    <td><input type="number" step="0.01" name="consumo_1" class="form-input small"></td>
                                    <td><input type="number" step="0.01" name="consumo_2" class="form-input small"></td>
                                    <td><input type="number" step="0.01" name="consumo_3" class="form-input small"></td>
                                    <td><input type="number" step="0.01" name="consumo_4" class="form-input small"></td>
                                    <td><input type="number" step="0.01" name="consumo_5" class="form-input small"></td>
                                    <td><input type="number" step="0.01" name="consumo_6" class="form-input small"></td>
                                </tr>
                            </tbody>
                        </table>
                        <div class="detail-field" style="margin-top: 12px;">
                            <label>Consumo Anual Total (kWh)</label>
                            <input type="number" step="0.01" name="consumo" class="form-input" style="max-width: 200px;">
                        </div>
                    </div>


                    <div class="detail-section">
                        <h4>Documentos</h4>
                        <div class="upload-area" id="uploadArea">
                            <div class="upload-icon">üìé</div>
                            <p>Arrastra archivos aqu√≠ o <label for="fileInput" style="color: #667eea; cursor: pointer; text-decoration: underline;">selecciona archivos</label></p>
                            <input type="file" id="fileInput" multiple="" style="display: none;">
                        </div>
                        <div id="uploadedFilesList" class="documents-list" style="margin-top: 12px;">

                        </div>
                    </div>


                    <div class="detail-section">
                        <h4>Observaciones</h4>
                        <textarea name="observaciones" class="form-textarea" rows="4" placeholder="Notas o comentarios adicionales sobre el contrato..."></textarea>
                    </div>


                    <div class="form-actions" style="display: flex; gap: 12px; padding: 20px 0; border-top: 1px solid #e2e8f0; margin-top: 20px;">
                        <button type="button" class="action-btn" id="cancelCreateBtn">Cancelar</button>
                        <button type="submit" class="action-btn primary" style="flex: 1; display: flex; align-items: center; justify-content: center; gap: 6px;" id="submitCreateBtn">
                            <span>‚ú®</span> <span>Crear Contrato</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- END Contratos View -->
    </div>

    <!-- Comparador View (Hidden) -->
    <div id="comparadorView" style="display: none;">

        <!-- Mode Selection -->
        <div id="modeSelection" style="max-width: 1200px; margin: 40px auto; padding: 0 20px;">
            <div style="text-align: center; margin-bottom: 48px;">
                <h2 style="font-size: 32px; font-weight: 700; color: #2d3748; margin: 0 0 12px 0;">Modo de An√°lisis</h2>
                <p style="font-size: 16px; color: #718096; margin: 0;">Selecciona el tipo de an√°lisis que deseas realizar</p>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px; margin-bottom: 40px;">

                <!-- Option 1: Comparaci√≥n de Facturas -->
                <div class="mode-option-card" onclick="startMode('comparison')">
                    <div style="font-size: 56px; margin-bottom: 20px;">üìä</div>
                    <h3 style="font-size: 20px; font-weight: 700; color: #2d3748; margin: 0 0 12px 0;">Comparaci√≥n de Facturas</h3>
                    <p style="font-size: 14px; color: #718096; line-height: 1.6; margin: 0;">Compara ofertas de diferentes comercializadoras y encuentra el mejor precio</p>
                </div>

                <!-- Option 2: An√°lisis de Potencia -->
                <div class="mode-option-card" onclick="startMode('power')">
                    <div style="font-size: 56px; margin-bottom: 20px;">‚ö°</div>
                    <h3 style="font-size: 20px; font-weight: 700; color: #2d3748; margin: 0 0 12px 0;">An√°lisis de Potencia</h3>
                    <p style="font-size: 14px; color: #718096; line-height: 1.6; margin: 0;">Optimiza la potencia contratada del cliente para reducir costes</p>
                </div>

                <!-- Option 3: An√°lisis Completo -->
                <div class="mode-option-card" onclick="startMode('both')">
                    <div style="font-size: 56px; margin-bottom: 20px;">üîÑ</div>
                    <h3 style="font-size: 20px; font-weight: 700; color: #2d3748; margin: 0 0 12px 0;">An√°lisis Completo</h3>
                    <p style="font-size: 14px; color: #718096; line-height: 1.6; margin: 0;">Comparaci√≥n de ofertas + an√°lisis de potencia en una sola herramienta</p>
                </div>

            </div>
        </div>

        <!-- Comparador Tool Container (loads after mode selection) -->
        <div id="comparador-tunergia" style="display: none;"></div>

    </div>

</div>

<!-- JavaScript Modules (load in order) -->
<script src="https://rawcdn.githack.com/pedrokrug/micro_crm_tunergia/5457bf6/src_prod/tunergia-core.js"></script>
<script src="https://rawcdn.githack.com/pedrokrug/micro_crm_tunergia/5457bf6/src_prod/tunergia-api.js"></script>
<script src="https://rawcdn.githack.com/pedrokrug/micro_crm_tunergia/5457bf6/src_prod/tunergia-ui.js"></script>

<!-- Pill Switcher Script -->
<script>
let comparadorLoaded = false;

function showContratos() {
    document.getElementById('contratosView').style.display = 'block';
    document.getElementById('comparadorView').style.display = 'none';
    document.querySelectorAll('.pill-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.pill-btn')[0].classList.add('active');
}

function showComparador() {
    document.getElementById('contratosView').style.display = 'none';
    document.getElementById('comparadorView').style.display = 'block';
    document.querySelectorAll('.pill-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.pill-btn')[1].classList.add('active');

    // Reset to mode selection
    const modeSelection = document.getElementById('modeSelection');
    const comparadorContainer = document.getElementById('comparador-tunergia');
    if (modeSelection) modeSelection.style.display = 'block';
    if (comparadorContainer) comparadorContainer.style.display = 'none';
}

async function startMode(mode) {
    console.log('Starting mode:', mode);

    // Hide mode selection
    document.getElementById('modeSelection').style.display = 'none';
    const container = document.getElementById('comparador-tunergia');
    container.style.display = 'block';

    if (mode === 'power') {
        // Power-only mode: Show custom interface
        container.innerHTML = `
            <div style="max-width: 1000px; margin: 40px auto; padding: 0 20px;">
                <div style="text-align: center; margin-bottom: 40px;">
                    <button onclick="backToModeSelection()" style="position: absolute; left: 20px; padding: 8px 16px; background: #f1f5f9; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">‚Üê Volver</button>
                    <h2 style="font-size: 28px; font-weight: 700; color: #2d3748; margin: 0 0 8px 0;">‚ö° An√°lisis de Potencia</h2>
                    <p style="font-size: 15px; color: #718096; margin: 0;">Optimiza la potencia contratada del cliente</p>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 24px;">

                    <!-- Option 1: Upload Bill -->
                    <div class="power-mode-card" onclick="showPowerUploadMode()">
                        <div style="font-size: 48px; margin-bottom: 16px;">üìÑ</div>
                        <h3 style="font-size: 18px; font-weight: 700; color: #2d3748; margin: 0 0 8px 0;">Subir Factura</h3>
                        <p style="font-size: 14px; color: #718096; line-height: 1.5; margin: 0;">Analiza la factura del cliente y recibe recomendaciones de potencia optimizada</p>
                    </div>

                    <!-- Option 2: Manual Input -->
                    <div class="power-mode-card" onclick="showPowerManualMode()">
                        <div style="font-size: 48px; margin-bottom: 16px;">‚öôÔ∏è</div>
                        <h3 style="font-size: 18px; font-weight: 700; color: #2d3748; margin: 0 0 8px 0;">Entrada Manual</h3>
                        <p style="font-size: 14px; color: #718096; line-height: 1.5; margin: 0;">Introduce el CUPS y configura manualmente los valores de potencia</p>
                    </div>

                </div>
            </div>
        `;
    } else {
        // Comparison or Both mode: Load full comparador
        container.innerHTML = '<div style="padding: 60px 20px; text-align: center;"><div class="loading-spinner"></div><p>Cargando comparador...</p></div>';

        try {
            // Load comparador script FIRST if not already loaded
            if (!comparadorLoaded) {
                await new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = 'https://rawcdn.githack.com/pedrokrug/micro_crm_tunergia/70afbf9/src_prod/modules/comparador/comparador.js';
                    script.onload = () => {
                        comparadorLoaded = true;
                        console.log('‚úì Comparador script loaded successfully');
                        console.log('‚úì switchTab function available:', typeof window.switchTab === 'function');
                        resolve();
                    };
                    script.onerror = (e) => {
                        console.error('Failed to load comparador.js:', e);
                        reject(new Error('Failed to load comparador script'));
                    };
                    document.body.appendChild(script);
                });
            }

            // Then fetch and insert HTML
            const response = await fetch('https://rawcdn.githack.com/pedrokrug/micro_crm_tunergia/70afbf9/src_prod/modules/comparador/comparador.html');
            if (!response.ok) throw new Error('Failed to load comparador HTML');

            const html = await response.text();
            container.innerHTML = html;

            // Wait for DOM to be fully rendered
            await new Promise(resolve => setTimeout(resolve, 150));

            console.log('‚úì Comparador loaded in mode:', mode);

            // Auto-enable power analysis for 'both' mode
            if (mode === 'both') {
                setTimeout(() => {
                    const powerCheckbox = document.getElementById('power-analysis-checkbox');
                    if (powerCheckbox && !powerCheckbox.checked) {
                        powerCheckbox.click();
                    }
                }, 500);
            }

        } catch (error) {
            console.error('Error loading comparador:', error);
            container.innerHTML = '<div style="padding: 40px; text-align: center; color: #e53e3e;"><h3>Error al cargar el comparador</h3><p>' + error.message + '</p></div>';
        }
    }
}

function backToModeSelection() {
    document.getElementById('modeSelection').style.display = 'block';
    document.getElementById('comparador-tunergia').style.display = 'none';
}

function showPowerUploadMode() {
    alert('Power Upload Mode - To be implemented: Show upload interface for bill analysis');
}

function showPowerManualMode() {
    alert('Power Manual Mode - To be implemented: Show manual CUPS/power input interface');
}

// Global switchTab placeholder (will be replaced by comparador.js)
window.switchTab = function(tab) {
    console.log('switchTab called before comparador.js loaded, tab:', tab);
};

window.showContratos = showContratos;
window.showComparador = showComparador;
window.startMode = startMode;
</script>

<!-- Pill Switcher Styles -->
<style>
.tool-switcher-pill {
    display: inline-flex;
    background: rgba(241, 245, 249, 0.6);
    backdrop-filter: blur(10px);
    border-radius: 12px;
    padding: 4px;
    gap: 4px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
}

.pill-btn {
    padding: 10px 28px;
    border: none;
    background: transparent;
    border-radius: 10px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    color: #64748b;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.pill-btn:hover {
    color: #334155;
    background: rgba(255, 255, 255, 0.5);
}

.pill-btn.active {
    background: white;
    color: #4392CD;
    box-shadow: 0 2px 8px rgba(67, 146, 205, 0.15);
}

/* Mode Option Cards */
.mode-option-card {
    background: white;
    border: 2px solid #e2e8f0;
    border-radius: 16px;
    padding: 40px 32px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.mode-option-card:hover {
    border-color: #4392CD;
    box-shadow: 0 8px 24px rgba(67, 146, 205, 0.15);
    transform: translateY(-4px);
}

.mode-option-card:active {
    transform: translateY(-2px);
}

/* Power Mode Cards */
.power-mode-card {
    background: white;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    padding: 32px 24px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.power-mode-card:hover {
    border-color: #4392CD;
    box-shadow: 0 6px 20px rgba(67, 146, 205, 0.15);
    transform: translateY(-3px);
}

.power-mode-card:active {
    transform: translateY(-1px);
}
</style>
